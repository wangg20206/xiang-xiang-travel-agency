<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>分割前後土地地稅計算</title>
  <link rel="icon" href="大溪地政.ico">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    .main-wrapper {
      padding: 24px;
      max-width: 80%;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
    }

    h2 {
      margin-top: 32px;
      color: #333;
    }

    h3 {
      margin-top: 32px;
      color: #e20505;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
      background: #fff;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: center;
    }

    th {
      background: #e0e0e0;
    }

    input[type="number"],
    input[type="text"] {
      width: 90%;
      padding: 4px;
      box-sizing: border-box;
    }

    .btn {
      padding: 6px 12px;
      margin: 4px;
      border: none;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
    }

    .btn-add {
      background: #4caf50;
    }

    .btn-calc {
      background: #2196f3;
    }

    .btn-del {
      background: #f44336;
    }

    #calcTaxBtn {
      background: #ff9800;
    }
  </style>
</head>

<body>
  <div id="header-container"></div>
  <div class="main-wrapper">

    <h1>共有物分割前後差額計算</h1>
    <h3>請確認輸入資料與共有物分割協議書相符</h3>
    <h3>本表計算結果僅供參考</h3>
    <h3>如要使用匯入檔案，請使用本網頁提供之計算格式(excel)</h3><br>

    <a href="./分割前後土地分割範例.xlsx" download class="btn btn-add">📥 下載 Excel 範例</a>
    <input type="file" id="importExcel" accept=".xlsx,.xls" />

    <!-- 分割前 -->
    <h2>分割前</h2>
    <table id="preTable">
      <thead>
        <tr>
          <th>鄉鎮市區</th>
          <th>段</th>
          <th>小段</th>
          <th>地號</th>
          <th>面積</th>
          <th>所有權人</th>
          <th>分子</th>
          <th>分母</th>
          <th>現值</th>
          <th>小計</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input class="township" type="text" /></td>
          <td><input class="part" type="text" /></td>
          <td><input class="small" type="text" /></td>
          <td><input class="land-id" type="text" /></td>
          <td><input class="area" type="number" min="0" /></td>
          <td><input class="owner" type="text" /></td>
          <td><input class="numerator" type="number" min="1" /></td>
          <td><input class="denominator" type="number" min="1" /></td>
          <td><input class="value" type="number" min="0" /></td>
          <td class="subtotal">—</td>
          <td><button class="btn btn-del">刪除</button></td>
        </tr>
      </tbody>
    </table>
    <button id="addPreBtn" class="btn btn-add">＋ 新增（分割前）</button>

    <!-- 分割後 -->
    <h2>分割後</h2>
    <table id="postTable">
      <thead>
        <tr>
          <th>鄉鎮市區</th>
          <th>段</th>
          <th>小段</th>
          <th>地號</th>
          <th>面積</th>
          <th>所有權人</th>
          <th>分子</th>
          <th>分母</th>
          <th>現值</th>
          <th>小計</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input class="township" type="text" /></td>
          <td><input class="part" type="text" /></td>
          <td><input class="small" type="text" /></td>
          <td><input class="land-id" type="text" /></td>
          <td><input class="area" type="number" min="0" /></td>
          <td><input class="owner" type="text" /></td>
          <td><input class="numerator" type="number" min="1" /></td>
          <td><input class="denominator" type="number" min="1" /></td>
          <td><input class="value" type="number" min="0" /></td>
          <td class="subtotal">—</td>
          <td><button class="btn btn-del">刪除</button></td>
        </tr>
      </tbody>
    </table>
    <button id="addPostBtn" class="btn btn-add">＋ 新增（分割後）</button><br><br>

    <button id="calcTaxBtn" class="btn btn-calc">計算</button>
    <button id="exportExcel" class="btn btn-calc">匯出結果 Excel</button>
    <button class="btn btn-calc" onclick="showStoredData()">顯示已儲存資料</button>
    <button class="btn btn-add" onclick="location.href='權利人資料輸入.html'">➡️ 前往繪製土地登記申請書(只可產生18人以下或90筆以下資料)
    </button>


    <table id="resultTable">
      <thead>
        <tr>
          <th>所有權人</th>
          <th>分割前總計</th>
          <th>分割後總計</th>
          <th>差額</th>
          <th>是否超過最小現值</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const preTbody = document.querySelector('#preTable tbody');
    const postTbody = document.querySelector('#postTable tbody');
    const addPreBtn = document.getElementById('addPreBtn');
    const addPostBtn = document.getElementById('addPostBtn');
    const calcTaxBtn = document.getElementById('calcTaxBtn');
    const resultTbody = document.querySelector('#resultTable tbody');

    // 1. 建立新列

    function createRowHTML() {
      return `
        <tr>
          <td><input class="township"  type="text" /></td>
          <td><input class="part"      type="text" /></td>
          <td><input class="small"     type="text" /></td>
          <td><input class="land-id"   type="text" /></td>
          <td><input class="area"      type="number" min="0" /></td>
          <td><input class="owner"     type="text" /></td>
          <td><input class="numerator" type="number" min="1" /></td>
          <td><input class="denominator" type="number" min="1" /></td>
          <td><input class="value"     type="number" min="0" /></td>
          <td class="subtotal">—</td>
          <td><button class="btn btn-del">刪除</button></td>
        </tr>`;
    }

    addPreBtn.addEventListener('click', () => preTbody.insertAdjacentHTML('beforeend', createRowHTML()));
    addPostBtn.addEventListener('click', () => postTbody.insertAdjacentHTML('beforeend', createRowHTML()));

    // 刪除列
    [preTbody, postTbody].forEach(tbody => {
      tbody.addEventListener('click', e => {
        if (e.target.matches('.btn-del')) e.target.closest('tr').remove();
      });
    });

    // 2. 匯入 Excel（假設前 9 欄是「分割前」，後 9 欄是「分割後」）
    document.getElementById('importExcel').addEventListener('change', handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

        preTbody.innerHTML = '';
        postTbody.innerHTML = '';

        // ===== 前面記憶變數 =====
        let prevPreTownship = '';
        let prevPrePart = '';
        let prevPreSmall = '';
        // ===== 後面記憶變數 =====
        let prevPostTownship = '';
        let prevPostPart = '';
        let prevPostSmall = '';

        rows.slice(2).forEach(r => {
          // --- 分割前：決定三個欄位要顯示的值 ---
          const curPreTownship = r[0] !== '' ? r[0] : prevPreTownship;
          const curPrePart = r[1] !== '' ? r[1] : prevPrePart;
          const curPreSmall = r[2] !== '' ? r[2] : prevPreSmall;
          // 更新記憶
          prevPreTownship = curPreTownship;
          prevPrePart = curPrePart;
          prevPreSmall = curPreSmall;

          if (!isNaN(r[4]) && r[4] !== '') {
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td><input class="township"  type="text" value="${curPreTownship}" /></td>
          <td><input class="part"      type="text" value="${curPrePart}"     /></td>
          <td><input class="small"     type="text" value="${curPreSmall}"    /></td>
          <td><input class="land-id"   type="text" value="${r[3] || ''}"   /></td>
          <td><input class="area"      type="number" value="${r[4] || ''}"   /></td>
          <td><input class="owner"     type="text"  value="${r[5] || ''}"   /></td>
          <td><input class="numerator" type="number" value="${r[6] || ''}"   /></td>
          <td><input class="denominator" type="number" value="${r[7] || ''}"   /></td>
          <td><input class="value"     type="number" value="${r[8] || ''}"   /></td>
          <td class="subtotal">—</td>
          <td><button class="btn btn-del">刪除</button></td>`;
            preTbody.appendChild(tr);
          }

          // --- 分割後：決定三個欄位要顯示的值 ---
          const curPostTownship = r[10] !== '' ? r[10] : prevPostTownship;
          const curPostPart = r[11] !== '' ? r[11] : prevPostPart;
          const curPostSmall = r[12] !== '' ? r[12] : prevPostSmall;
          // 更新記憶
          prevPostTownship = curPostTownship;
          prevPostPart = curPostPart;
          prevPostSmall = curPostSmall;

          // r[14] 是面積，用它來判斷是否插入這列
          if (!isNaN(r[14]) && r[14] !== '') {
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td><input class="township"  type="text" value="${curPostTownship}" /></td>
      <td><input class="part"      type="text" value="${curPostPart}"      /></td>
      <td><input class="small"     type="text" value="${curPostSmall}"     /></td>
      <td><input class="land-id"   type="text" value="${r[13] || ''}"     /></td>
      <td><input class="area"      type="number" value="${r[14] || ''}"     /></td>
      <td><input class="owner"     type="text"  value="${r[15] || ''}"     /></td>
      <td><input class="numerator" type="number" value="${r[16] || ''}"    /></td>
      <td><input class="denominator" type="number" value="${r[17] || ''}"    /></td>
      <td><input class="value"     type="number" value="${r[18] || ''}"     /></td>
      <td class="subtotal">—</td>
      <td><button class="btn btn-del">刪除</button></td>`;
            postTbody.appendChild(tr);
          }
        });
      };
      reader.readAsArrayBuffer(file);
    }

    function getLandDetailsAsShortCodes() {
      const extract = tbody => {
        const rows = [];
        tbody.querySelectorAll('tr').forEach(row => {
          const a = row.querySelector('.township')?.value || '';
          const b = row.querySelector('.part')?.value || '';
          const c = row.querySelector('.small')?.value || '';
          const d = row.querySelector('.land-id')?.value || '';
          const e = parseFloat(row.querySelector('.area')?.value) || 0;
          const f = row.querySelector('.owner')?.value || '';
          const g = parseInt(row.querySelector('.numerator')?.value) || 1;
          const h = parseInt(row.querySelector('.denominator')?.value) || 1;
          const i = row.querySelector('.subtotal')?.textContent || '';
          rows.push({ a, b, c, d, e, f, g, h, i });
        });
        return rows;
      };

      const landDetails = {
        pre: extract(preTbody),
        post: extract(postTbody)
      };

      localStorage.setItem('landDetails', JSON.stringify(landDetails));
    }

    // 3. 計算小計並匯總

    function tallyByOwner(tbody) {
      const map = {};
      tbody.querySelectorAll('tr').forEach(row => {
        const a = parseFloat(row.querySelector('.area').value);
        const n = parseFloat(row.querySelector('.numerator').value);
        const d = parseFloat(row.querySelector('.denominator').value);
        const v = parseFloat(row.querySelector('.value').value);
        const owner = row.querySelector('.owner').value.trim() || '未填';
        if (!isNaN(a) && !isNaN(n) && d > 0 && !isNaN(v)) {
          const sub = a * n / d * v;
          map[owner] = (map[owner] || 0) + sub;
          row.querySelector('.subtotal').textContent = sub.toFixed(2);
        } else {
          row.querySelector('.subtotal').textContent = '—';
        }
      });
      return map;
    }

    calcTaxBtn.addEventListener('click', () => {
      // ✅ 自動補值函數：補齊 鄉鎮市區、段、小段、地號
      function fillForward(tbody) {
        let lastTownship = '';
        let lastPart = '';
        let lastSmall = '';
        let lastLandId = '';

        tbody.querySelectorAll('tr').forEach(row => {
          const township = row.querySelector('.township');
          const part = row.querySelector('.part');
          const small = row.querySelector('.small');
          const landId = row.querySelector('.land-id');

          if (township.value.trim() !== '') lastTownship = township.value.trim();
          else township.value = lastTownship;

          if (part.value.trim() !== '') lastPart = part.value.trim();
          else part.value = lastPart;

          if (small.value.trim() !== '') lastSmall = small.value.trim();
          else small.value = lastSmall;

          if (landId.value.trim() !== '') lastLandId = landId.value.trim();
          else landId.value = lastLandId;
        });
      }

      // ✅ 執行自動補值
      fillForward(preTbody);
      fillForward(postTbody);

      // ✅ 計算小計並產出報表
      const preMap = tallyByOwner(preTbody);
      const postMap = tallyByOwner(postTbody);
      getLandDetailsAsShortCodes();

      const allVals = [...preTbody.querySelectorAll('.value'), ...postTbody.querySelectorAll('.value')]
        .map(i => parseFloat(i.value)).filter(v => !isNaN(v));
      const minVal = allVals.length ? Math.min(...allVals) : 0;

      resultTbody.innerHTML = '';
      new Set([...Object.keys(preMap), ...Object.keys(postMap)]).forEach(owner => {
        const preSum = preMap[owner] || 0;
        const postSum = postMap[owner] || 0;
        const diff = postSum - preSum;
        const flag = Math.abs(diff) > minVal ? '是' : '否';
        const tr = document.createElement('tr');
        tr.innerHTML = `
      <td>${owner}</td>
      <td>${preSum.toFixed(2)}</td>
      <td>${postSum.toFixed(2)}</td>
      <td>${diff.toFixed(2)}</td>
      <td>${flag}</td>`;
        resultTbody.appendChild(tr);
      });

      console.log('✅ 已儲存 landDetails 至 localStorage！');
    });




    // 4. 匯出 Excel
    document.getElementById('exportExcel').addEventListener('click', () => {
      calcTaxBtn.click();
      const ws = XLSX.utils.table_to_sheet(document.getElementById('resultTable'));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '計算結果');
      XLSX.writeFile(wb, '土地分割計算結果.xlsx');
      getLandDetailsAsShortCodes();
    });




    // 載入 header.html
    document.addEventListener("DOMContentLoaded", () => {

      // 每次重新整理自動清除儲存資料
      localStorage.removeItem('landDetails');

      fetch("header.html")
        .then(r => r.text())
        .then(html => document.getElementById("header-container").innerHTML = html)
        .catch(e => console.error("載入 header 失敗:", e));
    });




    function getLandDetailsAsShortCodes() {
      const extract = tbody => {
        const rows = [];
        tbody.querySelectorAll('tr').forEach(row => {
          const a = row.querySelector('.township')?.value || '';
          const b = row.querySelector('.part')?.value || '';
          const c = row.querySelector('.small')?.value || '';
          const d = row.querySelector('.land-id')?.value || '';
          const e = parseFloat(row.querySelector('.area')?.value) || 0;
          const f = row.querySelector('.owner')?.value || '';
          const g = parseInt(row.querySelector('.numerator')?.value) || 1;
          const h = parseInt(row.querySelector('.denominator')?.value) || 1;
          const i = row.querySelector('.subtotal')?.textContent || '';
          rows.push({ a, b, c, d, e, f, g, h, i });
        });
        return rows;
      };

      const landDetails = {
        pre: extract(preTbody),
        post: extract(postTbody)
      };

      // ✅ 儲存進 localStorage
      localStorage.setItem('landDetails', JSON.stringify(landDetails));
    }


    function showStoredData() {
      const data = localStorage.getItem('landDetails');
      if (data) {
        const parsed = JSON.parse(data);
        console.log("【分割前資料】：", parsed.pre);
        console.log("【分割後資料】：", parsed.post);
        alert("已儲存資料，請開啟 F12 → Console 查看詳細內容");
      } else {
        alert("尚未儲存任何資料！");
      }
    }




  </script>

</body>

</html>